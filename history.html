<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - Deploy System Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/layout.css" rel="stylesheet">
</head>

<body>

    <div id="header-container"></div>
    <script src="js/header.js"></script>

    <div class="d-flex">
        <!-- Sidebar -->
        <!-- Sidebar -->
        <div id="sidebar-container"></div>
        <script src="js/sidebar.js"></script>

        <!-- Content Area -->
        <div class="content-area">
            <h4 class="mb-4 pb-2 border-bottom"><i class="bi bi-clock-history me-2"></i>Action History</h4>

            <!-- Filters -->
            <div class="card shadow-sm mb-4 border-0 bg-light">
                <div class="card-body py-3">
                    <form id="historyFilterForm" onsubmit="event.preventDefault(); filterHistory();">
                        <div class="row mb-2">
                            <div class="col-12">
                                <label class="col-form-label fw-bold small text-uppercase text-secondary">Filter
                                    by</label>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label for="filterAgent" class="form-label small fw-bold">Agent Name</label>
                                <input type="text" class="form-control form-control-sm" id="filterAgent"
                                    placeholder="ex) Pay-WAS">
                            </div>
                            <div class="col-md-2" id="groupFilterContainer" style="display: none;">
                                <label for="filterGroup" class="form-label small fw-bold">Group</label>
                                <select class="form-select form-select-sm" id="filterGroup">
                                    <option value="">ALL</option>
                                    <option value="PD">PD</option>
                                    <option value="SO">SO</option>
                                    <option value="QA">QA</option>
                                    <option value="OP">OP</option>
                                    <option value="COMMON">Common</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="filterIp" class="form-label small fw-bold">IP Address</label>
                                <input type="text" class="form-control form-control-sm" id="filterIp"
                                    placeholder="part of IP">
                            </div>
                            <div class="col-md-2">
                                <label for="filterUser" class="form-label small fw-bold">User Name</label>
                                <input type="text" class="form-control form-control-sm" id="filterUser"
                                    placeholder="User Name">
                            </div>
                            <div class="col-md-2">
                                <label for="filterType" class="form-label small fw-bold">Action</label>
                                <select class="form-select form-select-sm" id="filterType">
                                    <option value="">ALL</option>
                                    <option value="START">START</option>
                                    <option value="STOP">STOP</option>
                                    <option value="RESTART">RESTART</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="filterResult" class="form-label small fw-bold">Result</label>
                                <select class="form-select form-select-sm" id="filterResult">
                                    <option value="">ALL</option>
                                    <option value="SUCCESS">Success</option>
                                    <option value="FAILED">Failed</option>
                                    <option value="PROCESSING">Processing</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Time Range</label>
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control" id="filterStartDate">
                                    <span class="input-group-text">~</span>
                                    <input type="date" class="form-control" id="filterEndDate">
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-end justify-content-end">
                                <button type="button" class="btn btn-sm btn-secondary me-2"
                                    onclick="resetHistoryFilter()"><i
                                        class="bi bi-arrow-counterclockwise me-1"></i>Reset</button>
                                <button type="submit" class="btn btn-sm btn-primary px-4"><i
                                        class="bi bi-search me-1"></i>Search</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- History Table -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="ps-4">Name</th>
                                <th scope="col">Group</th>
                                <th scope="col">IP Address</th>
                                <th scope="col">Action</th>
                                <th scope="col">Result</th>
                                <th scope="col">Time</th>
                                <th scope="col">User</th>
                                <th scope="col" class="text-end pe-4">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="ps-4 fw-bold">Pay-WAS-01</td>
                                <td><span class="badge rounded-pill text-bg-secondary bg-opacity-75">PD</span></td>
                                <td>192.168.0.10:8080</td>
                                <td><span
                                        class="badge bg-success bg-opacity-10 text-success border border-success">START</span>
                                </td>
                                <td><span class="text-success fw-bold"><i
                                            class="bi bi-check-circle-fill me-1"></i>Success</span></td>
                                <td class="text-muted small">2024-01-20 10:00:00</td>
                                <td>김관리</td>
                                <td class="text-end pe-4"><button class="btn btn-sm btn-link text-decoration-none"
                                        onclick="viewLog(this)">View
                                        Log</button></td>
                            </tr>
                            <tr>
                                <td class="ps-4 fw-bold">Order-API-01</td>
                                <td><span class="badge rounded-pill text-bg-secondary bg-opacity-75">SO</span></td>
                                <td>10.20.30.42:8080</td>
                                <td><span
                                        class="badge bg-warning bg-opacity-10 text-warning border border-warning">RESTART</span>
                                </td>
                                <td>
                                    <span class="spinner-border spinner-border-sm text-warning me-1"
                                        role="status"></span>
                                    <span class="text-warning fw-bold">Processing</span>
                                </td>
                                <td class="text-muted small">2024-01-19 09:30:00</td>
                                <td>이배포</td>
                                <td class="text-end pe-4"><button class="btn btn-sm btn-link text-decoration-none"
                                        onclick="viewLog(this)">View
                                        Log</button></td>
                            </tr>
                            <tr>
                                <td class="ps-4 fw-bold">Pay-WAS-02</td>
                                <td><span class="badge rounded-pill text-bg-secondary bg-opacity-75">PD</span></td>
                                <td>192.168.0.11:8080</td>
                                <td><span
                                        class="badge bg-danger bg-opacity-10 text-danger border border-danger">STOP</span>
                                </td>
                                <td><span class="text-danger fw-bold"><i
                                            class="bi bi-x-circle-fill me-1"></i>Failed</span></td>
                                <td class="text-muted small">2024-01-18 18:00:22</td>
                                <td>시스템</td>
                                <td class="text-end pe-4"><button class="btn btn-sm btn-link text-decoration-none"
                                        onclick="viewLog(this)">View
                                        Log</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-white d-flex justify-content-end py-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">Next</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title font-monospace"><i class="bi bi-terminal-fill me-2"></i><span
                            id="logModalTitle">Agent Log</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body bg-black p-0">
                    <pre class="m-0 p-3 text-success font-monospace" id="logContent"
                        style="font-size: 0.9rem; min-height: 400px; white-space: pre-wrap;"></pre>
                </div>
                <div class="modal-footer bg-dark border-top border-secondary">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>


        function generateMockLog(action, time, name, ip) {
            let log = `[${time}] LOG START for ${name} @ ${ip}\n`;
            log += `--------------------------------------------------\n`;

            if (action === 'RESTART' || action === 'START') {
                log += `[INFO] Received ${action} signal from Admin\n`;
                log += `[INFO] Stopping current process (PID: 1234)...\n`;
                log += `[INFO] Process stopped successfully.\n`;
                log += `[INFO] Initializing new instance...\n`;
                log += `[INFO] Loading configuration from /etc/agent/conf.d...\n`;
                log += `[INFO] Connecting to Message Broker (10.0.0.5:5672)... connected.\n`;
                log += `[INFO] Starting HTTP Server on port 8080...\n`;
                log += `[INFO] Health check passed available processors: 8.\n`;
                log += `[INFO] ${name} is now RUNNING.\n`;
            } else if (action === 'STOP') {
                log += `[INFO] Received STOP signal from System\n`;
                log += `[WARN] Draining active connections (timeout: 30s)...\n`;
                log += `[INFO] Active requests: 0.\n`;
                log += `[INFO] Shutting down HTTP Server...\n`;
                log += `[INFO] Disconnecting from Message Broker...\n`;
                log += `[INFO] Process exited with code 0.\n`;
            } else if (action === 'RESTART') {
                log += `[INFO] Restart initiated by User (LeeDeploy)\n`;
                log += `[INFO] Stopping service (PID: 9876)...\n`;
                log += `[INFO] Service stopped.\n`;
                log += `[INFO] Waiting for resources to release...\n`;
                log += `[INFO] Starting service...\n`;
                log += `[INFO] JVM Arguments: -Xms512m -Xmx2048m\n`;
                log += `[INFO] Service started successfully (New PID: 9988).\n`;
                log += `[INFO] Health check passed.\n`;
            } else if (action === 'HEALTH_CHECK') {
                log += `[INFO] Periodic Health Check Initiated.\n`;
                log += `[INFO] Checking CPU Usage... 15% (OK)\n`;
                log += `[INFO] Checking Memory Usage... 450MB/1024MB (OK)\n`;
                log += `[INFO] Checking Disk Space... 85% (WARN) - /var/log partition is filling up.\n`;
                log += `[ERROR] Database connection pool exhausted.\n`;
                log += `[ERROR] Health Check FAILED.\n`;
            } else {
                log += `[INFO] Generic action log...\n`;
                log += `[INFO] Operation completed.\n`;
            }

            log += `--------------------------------------------------\n`;
            log += `[${time}] LOG END\n`;

            // Add some color simulation using simple spans if needed
            return log.replace(/\[INFO\]/g, '<span class="text-info">[INFO]</span>')
                .replace(/\[WARN\]/g, '<span class="text-warning">[WARN]</span>')
                .replace(/\[ERROR\]/g, '<span class="text-danger">[ERROR]</span>');
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Simulate Admin Checker
            // In real app, check currentUser.level or server-side rendered flag.
            // Here we just check the navbar text for 'Admin'.
            const navbarText = document.querySelector('.navbar-brand').nextElementSibling?.innerText || '';
            // Or better, just check the specific element
            const userBadge = document.querySelector('nav .text-white small');
            if (userBadge && userBadge.innerText.includes('Admin')) {
                document.getElementById('groupFilterContainer').style.display = 'block';
            }
        });

        // --- History Filter Logic ---
        function filterHistory() {
            const agentVal = document.getElementById('filterAgent').value.toUpperCase();
            const groupVal = document.getElementById('filterGroup').value.toUpperCase(); // NEW
            const ipVal = document.getElementById('filterIp').value;
            const typeVal = document.getElementById('filterType').value;
            const resultVal = document.getElementById('filterResult').value;
            const userVal = document.getElementById('filterUser').value.toUpperCase();
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            const rows = document.querySelectorAll('table tbody tr');

            rows.forEach(row => {
                // Columns: 0=Name, 1=Group, 2=IP, 3=Action, 4=Result, 5=Time, 6=User, 7=Details
                const agentText = row.cells[0].innerText.trim().toUpperCase();
                const groupText = row.cells[1].innerText.trim().toUpperCase(); // NEW
                const ipText = row.cells[2].innerText.trim();
                const actionText = row.cells[3].innerText.trim(); // Contains Badge text
                const resultText = row.cells[4].innerText.trim().toUpperCase();
                const timeText = row.cells[5].innerText.trim();
                const datePart = timeText.substring(0, 10);
                const userText = row.cells[6].innerText.trim().toUpperCase();

                // Checks
                if (agentVal && !agentText.includes(agentVal)) { row.style.display = 'none'; return; }
                if (groupVal && !groupText.includes(groupVal)) { row.style.display = 'none'; return; } // NEW
                if (ipVal && !ipText.includes(ipVal)) { row.style.display = 'none'; return; }

                // For Action/Result (Exact or Includes - using includes for simplicity with text)
                // However, Action is strict match in dropdown, so let's use includes to be safe with badge text
                if (typeVal && !actionText.includes(typeVal)) { row.style.display = 'none'; return; }

                // Result has 'Success', 'Failed' text
                if (resultVal && !resultText.includes(resultVal)) { row.style.display = 'none'; return; }

                if (userVal && !userText.includes(userVal)) { row.style.display = 'none'; return; }

                if (startDate && datePart < startDate) { row.style.display = 'none'; return; }
                if (endDate && datePart > endDate) { row.style.display = 'none'; return; }

                row.style.display = '';
            });
        }

        // 1. Agent Name (Partial Match) - REMOVED DUPLICATE LOGIC

        function resetHistoryFilter() {
            document.getElementById('historyFilterForm').reset();
            // Manually clear inputs just in case
            document.getElementById('filterAgent').value = '';
            document.getElementById('filterGroup').value = '';
            document.getElementById('filterIp').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterResult').value = '';
            document.getElementById('filterUser').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            filterHistory();
        }

        function viewLog(btn) {
            const row = btn.closest('tr');
            if (!row) return;

            // Extract Data (Updated for Group Column)
            // 0=Name, 1=Group, 2=IP, 3=Action, 4=Result, 5=Time
            const agentName = row.cells[0].innerText.trim();
            const ip = row.cells[2].innerText.trim();
            const actionBadge = row.cells[3].querySelector('.badge');
            const action = actionBadge ? actionBadge.innerText.trim() : 'UNKNOWN';
            const time = row.cells[5].innerText.trim();

            // Set Title
            document.getElementById('logModalTitle').innerText = `[${action}] ${agentName} (${ip})`;

            // Generate Mock Log
            const logContent = generateMockLog(action, time, agentName, ip);
            document.getElementById('logContent').innerHTML = logContent;

            // Show Modal
            const logModal = new bootstrap.Modal(document.getElementById('logModal'));
            logModal.show();
        }
    </script>

</html>