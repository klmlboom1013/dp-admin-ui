<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - Deploy System Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/layout.css" rel="stylesheet">
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="./dashboard.html">
                <i class="bi bi-rocket-takeoff-fill me-2"></i>Deploy System
            </a>
            <div class="d-flex align-items-center text-white">
                <small class="me-3">Admin (김관리)</small>
                <a href="./login.html" class="btn btn-sm btn-outline-light">Logout</a>
            </div>
        </div>
    </nav>

    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column flex-shrink-0 p-3">
            <span class="sidebar-heading">Monitoring</span>
            <ul class="nav nav-pills flex-column">
                <li><a href="./dashboard.html" class="nav-link"><i class="bi bi-speedometer2"></i>대시보드 (Dashboard)</a>
                </li>
            </ul>
            <hr class="text-secondary">
            <span class="sidebar-heading">Management</span>
            <ul class="nav nav-pills flex-column mb-auto">
                <li><a href="./agent-list.html" class="nav-link"><i class="bi bi-hdd-rack"></i>Agent 관리</a></li>
                <li><a href="./agent-group-list.html" class="nav-link"><i class="bi bi-collection"></i>Agent 그룹 관리</a>
                </li>
                <li><a href="./history.html" class="nav-link"><i class="bi bi-clock-history"></i>배포/구동 이력</a></li>
            </ul>
            <hr class="text-secondary">
            <span class="sidebar-heading">System</span>
            <ul class="nav nav-pills flex-column">
                <li><a href="./user-list.html" class="nav-link"><i class="bi bi-people-fill"></i>사용자 관리</a></li>
                <li class="menu-admin-only"><a href="./settings.html" class="nav-link"><i class="bi bi-gear-fill"></i>환경
                        설정</a></li>
            </ul>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <h4 class="mb-4 pb-2 border-bottom"><i class="bi bi-clock-history me-2"></i>배포 및 구동 이력</h4>

            <!-- Filters -->
            <div class="card shadow-sm mb-4 border-0 bg-light">
                <div class="card-body py-3">
                    <form id="historyFilterForm" onsubmit="event.preventDefault(); filterHistory();">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label class="col-form-label fw-bold small text-uppercase text-secondary">Filter
                                    by</label>
                            </div>
                            <!-- Agent: Input for Partial Match -->
                            <div class="col-auto">
                                <input type="text" class="form-control form-control-sm" id="filterAgent"
                                    placeholder="Agent Name">
                            </div>
                            <!-- Type: Select -->
                            <div class="col-auto">
                                <select class="form-select form-select-sm" id="filterType">
                                    <option value="">전체 유형</option>
                                    <option value="START">Start</option>
                                    <option value="STOP">Stop</option>
                                </select>
                            </div>
                            <!-- Result: Select -->
                            <div class="col-auto">
                                <select class="form-select form-select-sm" id="filterResult">
                                    <option value="">전체 결과</option>
                                    <option value="SUCCESS">Success</option>
                                    <option value="FAILED">Failed</option>
                                    <option value="PROCESSING">Processing</option>
                                </select>
                            </div>
                            <!-- User: Input -->
                            <div class="col-auto">
                                <input type="text" class="form-control form-control-sm" id="filterUser"
                                    placeholder="User Name">
                            </div>
                            <!-- Date Range -->
                            <div class="col-auto">
                                <div class="input-group input-group-sm">
                                    <input type="date" class="form-control" id="filterStartDate">
                                    <span class="input-group-text">~</span>
                                    <input type="date" class="form-control" id="filterEndDate">
                                </div>
                            </div>
                            <div class="col-auto ms-auto">
                                <button type="button" class="btn btn-secondary btn-sm me-1"
                                    onclick="resetHistoryFilter()">Reset</button>
                                <button type="submit" class="btn btn-primary btn-sm px-3">Search</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- History Table -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="ps-4">Time</th>
                                <th scope="col">Agent Info</th>
                                <th scope="col">Action Type</th>
                                <th scope="col">User</th>
                                <th scope="col">Result</th>
                                <th scope="col" class="text-end pe-4">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="ps-4 text-muted small">2024-01-20 10:00:00</td>
                                <td>
                                    <span class="fw-bold">Pay-WAS-01</span>
                                    <small class="text-muted d-block">192.168.0.10</small>
                                </td>
                                <td><span
                                        class="badge bg-success bg-opacity-10 text-success border border-success">START</span>
                                </td>
                                <td>김관리</td>
                                <td><span class="text-success fw-bold"><i
                                            class="bi bi-check-circle-fill me-1"></i>Success</span></td>
                                <td class="text-end pe-4"><button class="btn btn-sm btn-link text-decoration-none"
                                        onclick="viewLog(this)">View
                                        Log</button></td>
                            </tr>
                            <tr>
                                <td class="ps-4 text-muted small">2024-01-19 09:30:00</td>
                                <td>
                                    <span class="fw-bold">Order-API-01</span>
                                    <small class="text-muted d-block">10.20.30.42</small>
                                </td>
                                <td><span
                                        class="badge bg-warning bg-opacity-10 text-warning border border-warning">DEPLOY</span>
                                </td>
                                <td>이배포</td>
                                <td>
                                    <span class="spinner-border spinner-border-sm text-warning me-1"
                                        role="status"></span>
                                    <span class="text-warning fw-bold">Processing</span>
                                </td>
                                <td class="text-end pe-4"><button class="btn btn-sm btn-link text-decoration-none"
                                        onclick="viewLog(this)">View
                                        Log</button></td>
                            </tr>
                            <tr>
                                <td class="ps-4 text-muted small">2024-01-18 18:00:22</td>
                                <td>
                                    <span class="fw-bold">Pay-WAS-02</span>
                                    <small class="text-muted d-block">192.168.0.11</small>
                                </td>
                                <td><span
                                        class="badge bg-danger bg-opacity-10 text-danger border border-danger">STOP</span>
                                </td>
                                <td>시스템</td>
                                <td><span class="text-success fw-bold"><i
                                            class="bi bi-check-circle-fill me-1"></i>Success</span></td>
                                <td class="text-end pe-4"><button class="btn btn-sm btn-link text-decoration-none"
                                        onclick="viewLog(this)">View
                                        Log</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-white d-flex justify-content-end py-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">Next</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title font-monospace"><i class="bi bi-terminal-fill me-2"></i><span
                            id="logModalTitle">Agent Log</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body bg-black p-0">
                    <pre class="m-0 p-3 text-success font-monospace" id="logContent"
                        style="font-size: 0.9rem; min-height: 400px; white-space: pre-wrap;"></pre>
                </div>
                <div class="modal-footer bg-dark border-top border-secondary">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        function viewLog(btn) {
            const row = btn.closest('tr');
            if (!row) return;

            // Extract Data
            const time = row.cells[0].innerText.trim();
            const agentName = row.querySelector('.fw-bold').innerText.trim();
            const ip = row.querySelector('small.text-muted').innerText.trim();
            const actionBadge = row.cells[2].querySelector('.badge');
            const action = actionBadge ? actionBadge.innerText.trim() : 'UNKNOWN';

            // Set Title
            document.getElementById('logModalTitle').innerText = `[${action}] ${agentName} (${ip})`;

            // Generate Mock Log
            const logContent = generateMockLog(action, time, agentName, ip);
            document.getElementById('logContent').innerHTML = logContent;

            // Show Modal
            const logModal = new bootstrap.Modal(document.getElementById('logModal'));
            logModal.show();
        }

        function generateMockLog(action, time, name, ip) {
            let log = `[${time}] LOG START for ${name} @ ${ip}\n`;
            log += `--------------------------------------------------\n`;

            if (action === 'RESTART' || action === 'START') {
                log += `[INFO] Received ${action} signal from Admin\n`;
                log += `[INFO] Stopping current process (PID: 1234)...\n`;
                log += `[INFO] Process stopped successfully.\n`;
                log += `[INFO] Initializing new instance...\n`;
                log += `[INFO] Loading configuration from /etc/agent/conf.d...\n`;
                log += `[INFO] Connecting to Message Broker (10.0.0.5:5672)... connected.\n`;
                log += `[INFO] Starting HTTP Server on port 8080...\n`;
                log += `[INFO] Health check passed available processors: 8.\n`;
                log += `[INFO] ${name} is now RUNNING.\n`;
            } else if (action === 'STOP') {
                log += `[INFO] Received STOP signal from System\n`;
                log += `[WARN] Draining active connections (timeout: 30s)...\n`;
                log += `[INFO] Active requests: 0.\n`;
                log += `[INFO] Shutting down HTTP Server...\n`;
                log += `[INFO] Disconnecting from Message Broker...\n`;
                log += `[INFO] Process exited with code 0.\n`;
            } else if (action === 'DEPLOY') {
                log += `[INFO] Deployment started by User (LeeDeploy)\n`;
                log += `[INFO] Downloading artifact 'order-api-v2.0.1.jar' from Artifact Repo...\n`;
                log += `[INFO] Download 10%...\n`;
                log += `[INFO] Download 50%...\n`;
                log += `[INFO] Download 100% (Size: 45MB).\n`;
                log += `[INFO] Verifying Checksum (SHA256)... OK.\n`;
                log += `[INFO] Backing up current version to /backup/order-api-v2.0.0.jar...\n`;
                log += `[INFO] Stopping service...\n`;
                log += `[INFO] Applying new artifact...\n`;
                log += `[INFO] Starting service...\n`;
                log += `[INFO] Deployment Completed Successfully.\n`;
            } else if (action === 'HEALTH_CHECK') {
                log += `[INFO] Periodic Health Check Initiated.\n`;
                log += `[INFO] Checking CPU Usage... 15% (OK)\n`;
                log += `[INFO] Checking Memory Usage... 450MB/1024MB (OK)\n`;
                log += `[INFO] Checking Disk Space... 85% (WARN) - /var/log partition is filling up.\n`;
                log += `[ERROR] Database connection pool exhausted.\n`;
                log += `[ERROR] Health Check FAILED.\n`;
            } else {
                log += `[INFO] Generic action log...\n`;
                log += `[INFO] Operation completed.\n`;
            }

            log += `--------------------------------------------------\n`;
            log += `[${time}] LOG END\n`;

            // Add some color simulation using simple spans if needed
            return log.replace(/\[INFO\]/g, '<span class="text-info">[INFO]</span>')
                .replace(/\[WARN\]/g, '<span class="text-warning">[WARN]</span>')
                .replace(/\[ERROR\]/g, '<span class="text-danger">[ERROR]</span>');
        }

        // --- History Filter Logic ---
        function filterHistory() {
            const agentVal = document.getElementById('filterAgent').value.toUpperCase();
            const typeVal = document.getElementById('filterType').value;
            const resultVal = document.getElementById('filterResult').value;
            const userVal = document.getElementById('filterUser').value.toUpperCase();
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            const rows = document.querySelectorAll('table tbody tr');

            rows.forEach(row => {
                // Columns: 0=Time, 1=Info(Name), 2=Action, 3=User, 4=Result, 5=Details
                const timeText = row.cells[0].innerText.trim();
                const datePart = timeText.substring(0, 10);
                const agentText = row.cells[1].innerText.trim().toUpperCase();
                const actionText = row.cells[2].innerText.trim(); // Contains Badge text
                const userText = row.cells[3].innerText.trim().toUpperCase();
                const resultText = row.cells[4].innerText.trim().toUpperCase();

                // 1. Agent Name (Partial Match)
                if (agentVal && !agentText.includes(agentVal)) {
                    row.style.display = 'none';
                    return;
                }
                // 2. Action Type
                if (typeVal && !actionText.includes(typeVal)) {
                    row.style.display = 'none';
                    return;
                }
                // 3. Result Status
                if (resultVal && !resultText.includes(resultVal)) {
                    row.style.display = 'none';
                    return;
                }
                // 4. User
                if (userVal && !userText.includes(userVal)) {
                    row.style.display = 'none';
                    return;
                }
                // 5. Date Range
                if (startDate && datePart < startDate) {
                    row.style.display = 'none';
                    return;
                }
                if (endDate && datePart > endDate) {
                    row.style.display = 'none';
                    return;
                }

                row.style.display = '';
            });
        }

        function resetHistoryFilter() {
            document.getElementById('historyFilterForm').reset();
            filterHistory();
        }
    </script>

</html>