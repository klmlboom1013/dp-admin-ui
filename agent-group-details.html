<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Group Details - Deploy System Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/layout.css" rel="stylesheet">
    <style>
        /* Edit Mode Styles */
        .btn-remove-agent {
            display: none;
        }

        .edit-mode .btn-remove-agent {
            display: inline-block;
        }
    </style>
</head>

<body>

    <div id="header-container" data-show-simulator="true"></div>
    <script src="js/header.js"></script>

    <div class="d-flex">
        <!-- Sidebar -->
        <!-- Sidebar -->
        <div id="sidebar-container"></div>
        <script src="js/sidebar.js"></script>

        <!-- Content Area -->
        <div class="content-area">
            <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
                <h4><i class="bi bi-collection me-2"></i>Agent Group Details</h4>
                <a href="./agent-group-list.html" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 목록으로
                </a>
            </div>

            <!-- Group Info Section -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-info-circle me-1"></i> 그룹 정보</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="btnEdit"
                            onclick="toggleEditMode(true)">Edit</button>
                        <button class="btn btn-sm btn-success d-none" id="btnSave"
                            onclick="saveGroupInfo()">Save</button>
                        <button class="btn btn-sm btn-secondary d-none" id="btnCancel"
                            onclick="cancelEdit()">Cancel</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="groupName" class="form-label fw-bold">Group Name</label>
                            <input type="text" class="form-control" id="groupName" placeholder="Enter Group Name"
                                disabled>
                        </div>
                        <div class="col-md-2">
                            <label for="ownerGroup" class="form-label fw-bold">Owner Group <span
                                    class="text-danger">*</span></label>
                            <div id="ownerGroupContainer">
                                <!-- Dynamically rendered -->
                                <input type="text" class="form-control" value="Loading..." readonly disabled>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="groupDesc" class="form-label fw-bold">Description</label>
                            <input type="text" class="form-control" id="groupDesc" placeholder="Enter Description"
                                disabled>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent List in Group Section -->
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold"><i class="bi bi-list-check me-2"></i>Attached Agents</h5>
                <button class="btn btn-sm btn-outline-primary d-none" id="btnAddAgent" onclick="openAddAgentModal()">
                    <i class="bi bi-plus-lg"></i> Agent 추가
                </button>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0" id="groupAgentTable">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="ps-4" style="width: 50px;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                    </div>
                                </th>
                                <th scope="col">Name</th>
                                <th scope="col">Group</th>
                                <th scope="col">IP Address</th>
                                <th scope="col">Status</th>
                                <th scope="col">Last Update</th>
                                <th scope="col" class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Mock Data for Group -->
                            <!-- Dynamically populated or static mock for now -->
                        </tbody>
                    </table>
                    <!-- Empty state message if needed -->
                    <div id="emptyState" class="text-center py-5 text-muted d-none">
                        그룹에 소속된 Agent가 없습니다.
                    </div>
                </div>
            </div>

            <!-- Bulk Action Toolbar (Scoped to this Group) -->
            <div id="bulkToolbar" class="floating-toolbar">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2 rounded-pill" id="selectedCount">0</span>
                    <span class="fw-bold">Agents Selected</span>
                </div>

                <div class="d-flex align-items-center gap-3">
                    <!-- Execution Option -->
                    <div class="btn-group" role="group" aria-label="Execution Toggle">
                        <input type="radio" class="btn-check" name="execMode" id="modeSequ" value="SEQUENTIAL" checked>
                        <label class="btn btn-outline-light btn-sm" for="modeSequ" title="Execute one by one">
                            <i class="bi bi-collection-play"></i> 순차 (Semi)
                        </label>

                        <input type="radio" class="btn-check" name="execMode" id="modePara" value="PARALLEL">
                        <label class="btn btn-outline-light btn-sm" for="modePara" title="Execute all at once">
                            <i class="bi bi-arrows-move"></i> 동시 (Para)
                        </label>
                    </div>

                    <div class="vr bg-secondary opacity-50"></div>

                    <div class="action-group">
                        <button class="btn btn-success btn-sm px-3 fw-bold" onclick="runGroupBulkAction('START')">
                            <i class="bi bi-play-fill"></i> Start
                        </button>
                        <button class="btn btn-danger btn-sm px-3 fw-bold" onclick="runGroupBulkAction('STOP')">
                            <i class="bi bi-stop-fill"></i> Stop
                        </button>
                        <button class="btn btn-warning btn-sm px-3 fw-bold text-dark"
                            onclick="runGroupBulkAction('RESTART')">
                            <i class="bi bi-arrow-clockwise"></i> Restart
                        </button>
                    </div>

                    <button class="btn btn-link text-white-50 p-0 ms-2" onclick="clearSelection()">
                        <i class="bi bi-x-circle fs-5"></i>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Add Agent Modal -->
    <div class="modal fade" id="addAgentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Agent to Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">그룹에 추가할 Agent를 선택하세요.</p>
                    <div class="list-group" id="availableAgentList">
                        <!-- Mock List of Available Agents -->
                        <label class="list-group-item d-flex gap-2">
                            <input class="form-check-input flex-shrink-0" type="checkbox" value="A-007">
                            <span>
                                <strong>Pay-WAS-05</strong>
                                <small class="text-muted d-block">Available Agent</small>
                            </span>
                        </label>
                        <label class="list-group-item d-flex gap-2">
                            <input class="form-check-input flex-shrink-0" type="checkbox" value="A-008">
                            <span>
                                <strong>Order-API-03</strong>
                                <small class="text-muted d-block">Available Agent</small>
                            </span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addSelectedAgents()">Add Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1060">
        <!-- Toasts will be dynamically appended here -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>

    <script>
        // --- Initialization ---
        const urlParams = new URLSearchParams(window.location.search);
        const groupNameInput = document.getElementById('groupName');
        const groupDescInput = document.getElementById('groupDesc');
        const ownerGroupContainer = document.getElementById('ownerGroupContainer'); // Check if redundant declaration

        // Remove Local Simulator Logic (Handled globally by header.js)

        // Initialize UI Logic
        document.addEventListener('DOMContentLoaded', () => {
            // Apply initial permissions check
            checkGroupAccess();
            updateGroupInfoUI();
        });

        // Listen for Global Context Change
        document.addEventListener('userContextChanged', (e) => {
            if (isEditMode) cancelEdit(); // Reset edit mode on context switch
            checkGroupAccess();
            updateGroupInfoUI();
            // Re-render list if needed (for mock only) ?
            // In real app we might reload data. Here existing mock data is static.
            showGlobalToast(`[Page] Context switched to: ${currentUser.name} (${currentUser.level})`);
        });

        function checkGroupAccess() {
            // If editing an existing group, non-Admins must match the Owner Group
            // Logic: Read the Owner Group from the page logic (container dataset)
            const currentOwnerGroup = document.getElementById('ownerGroupContainer').dataset.currentGroup;

            // If new group, access is allowed (they will create for their group)
            if (isNewGroup) return;

            if (currentUser.level !== 'Admin' && currentOwnerGroup) {
                if (currentOwnerGroup !== currentUser.group) {
                    // Access Denied simulation
                    showGlobalToast('Access Denied: You do not belong to this group.', 'danger');
                    document.querySelector('.content-area').style.opacity = '0.2';
                    document.querySelector('.content-area').style.pointerEvents = 'none';
                    // Optional: Redirect
                    // window.location.href = 'agent-group-list.html';
                } else {
                    document.querySelector('.content-area').style.opacity = '1';
                    document.querySelector('.content-area').style.pointerEvents = 'auto';
                }
            } else {
                // Admin or Match
                document.querySelector('.content-area').style.opacity = '1';
                document.querySelector('.content-area').style.pointerEvents = 'auto';
            }
        }

        // --- Agent Table & Selection Logic ---
        const tableBody = document.querySelector('#groupAgentTable tbody');
        let selectedRows = new Set();
        const toolbar = document.getElementById('bulkToolbar');
        const countBadge = document.getElementById('selectedCount');
        const selectAllCheckbox = document.getElementById('selectAll');

        // State
        let isEditMode = false;
        let isNewGroup = false;

        // Mock Initial Data

        if (urlParams.get('name')) {
            groupNameInput.value = urlParams.get('name');
            groupDescInput.value = urlParams.get('desc') || '';
            // Default Owner Group for mock
            ownerGroupContainer.dataset.currentGroup = 'PD';

            // Generate some mock agents for this group
            renderAgentTable([
                { id: 'A-003', name: 'Order-API-01', status: 'STARTING', serverType: 'DEV', ip: '192.168.0.10:8080', lastUpdate: '2024-01-19 11:30' },
                { id: 'A-006', name: 'Order-API-02', status: 'RUNNING', serverType: 'PROD', ip: '10.20.30.43:8080', lastUpdate: '2024-01-19 10:00' }
            ]);
        } else {
            // New Group -> Default to Edit Mode
            isNewGroup = true;
            groupNameInput.value = '';
            // Default Owner Group for new group (could be user's group)
            ownerGroupContainer.dataset.currentGroup = 'PD';

            document.getElementById('emptyState').classList.remove('d-none');
            // Ensure DOM is fully ready before toggling? Script is at end of body so it should be fine.
            setTimeout(() => toggleEditMode(true), 0);
        }

        // Initial Render of Group Info
        updateGroupInfoUI();


        // --- View/Edit Mode Logic ---
        function updateGroupInfoUI() {
            const container = document.getElementById('ownerGroupContainer');
            if (!container) return;

            const currentGroup = container.dataset.currentGroup || 'PD';
            const isAdmin = currentUser.level === 'TopAdmin';

            let html = '';

            if (isEditMode) {
                if (isAdmin) {
                    // Admin in Edit Mode: Select Box
                    html = `<select class="form-select" id="ownerGroup">`;
                    mockGroups.forEach(g => {
                        const selected = g === currentGroup ? 'selected' : '';
                        html += `<option value="${g}" ${selected}>${g}</option>`;
                    });
                    html += `</select>`;
                } else {
                    // User in Edit Mode: Read-only
                    // If creating new (isNewGroup), default to their group? 
                    // Requirement says "Admin이 아닌 계정은 자신이 속한 그룹 코드가 보여지고"
                    // If editing, they see the *current* group (which they might own).
                    // If they are creating, they see *their* group.
                    const displayGroup = isNewGroup ? currentUser.group : currentGroup;
                    html = `<input type="text" class="form-control" id="ownerGroup" value="${displayGroup}" readonly disabled>`;
                }
            } else {
                // View Mode: Always Text (Disabled)
                html = `<input type="text" class="form-control" id="ownerGroup" value="${currentGroup}" disabled>`;
            }
            container.innerHTML = html;
        }

        function toggleEditMode(forceEdit = null) {
            isEditMode = forceEdit !== null ? forceEdit : !isEditMode;

            // Buttons
            const btnEdit = document.getElementById('btnEdit');
            const btnSave = document.getElementById('btnSave');
            const btnCancel = document.getElementById('btnCancel');
            const btnAddAgent = document.getElementById('btnAddAgent');

            // Inputs
            groupNameInput.disabled = !isEditMode;
            groupDescInput.disabled = !isEditMode;

            // Re-render Owner Group field based on new mode
            updateGroupInfoUI();

            if (isEditMode) {
                // Edit Mode Active
                btnEdit.classList.add('d-none');
                btnSave.classList.remove('d-none');
                btnCancel.classList.remove('d-none');
                btnAddAgent.classList.remove('d-none');

                // Hide Bulk Action Checkboxes (Disable Bulk Actions)
                document.querySelectorAll('#groupAgentTable .form-check-input').forEach(cb => cb.disabled = true);
                if (toolbar.classList.contains('show')) clearSelection(); // Clear selection if entering edit mode

                // Show Remove Buttons
                document.body.classList.add('edit-mode');
            } else {
                // View Mode Active
                btnEdit.classList.remove('d-none');
                btnSave.classList.add('d-none');
                btnCancel.classList.add('d-none');
                btnAddAgent.classList.add('d-none');

                // Show Bulk Action Checkboxes
                document.querySelectorAll('#groupAgentTable .form-check-input').forEach(cb => cb.disabled = false);

                // Hide Remove Buttons
                document.body.classList.remove('edit-mode');
            }
        }

        function saveGroupInfo() {
            // Save Owner Group if it was editable
            const ownerGroupSelect = document.getElementById('ownerGroup');
            if (ownerGroupSelect && ownerGroupSelect.tagName === 'SELECT') {
                document.getElementById('ownerGroupContainer').dataset.currentGroup = ownerGroupSelect.value;
            }

            if (isNewGroup) {
                showGlobalToast('새로운 그룹 생성 완료 (시뮬레이션)', 'success');
                setTimeout(() => {
                    window.location.href = './agent-group-list.html';
                }, 1000);
                return;
            }
            showGlobalToast('그룹 정보가 저장되었습니다.');
            toggleEditMode(false);
        }

        function cancelEdit() {
            if (isNewGroup) {
                window.location.href = './agent-group-list.html';
                return;
            }
            // Revert changes if needed (not implemented for mock), just exit mode
            toggleEditMode(false);
        }

        function renderAgentTable(agents) {
            tableBody.innerHTML = '';
            if (agents.length === 0) {
                document.getElementById('emptyState').classList.remove('d-none');
                return;
            }
            document.getElementById('emptyState').classList.add('d-none');

            agents.forEach(agent => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.dataset.status = agent.status;
                tr.dataset.serverType = agent.serverType || '';

                let badgeClass = 'bg-secondary';
                if (agent.status === 'RUNNING') badgeClass = 'bg-success bg-opacity-10 text-success border border-success';
                else if (agent.status === 'STOPPED') badgeClass = 'bg-danger bg-opacity-10 text-danger border border-danger';
                else if (agent.status === 'STARTING') badgeClass = 'bg-info bg-opacity-10 text-info border border-info';
                else if (agent.status === 'STOPPING') badgeClass = 'bg-danger bg-opacity-10 text-danger border border-danger';

                let serverTypeBadge = '';
                if (agent.serverType) {
                    let typeClass = 'bg-light text-secondary border'; // Default (DEV)
                    if (agent.serverType === 'STG') typeClass = 'bg-success bg-opacity-10 text-success border border-success';
                    else if (agent.serverType === 'PROD') typeClass = 'bg-primary bg-opacity-10 text-primary border border-primary';

                    serverTypeBadge = `<span class="badge ${typeClass} ms-1">${agent.serverType}</span>`;
                }

                const lastUpdate = agent.lastUpdate || '2024-01-19 10:00';
                const isTransient = agent.status === 'STARTING' || agent.status === 'STOPPING';
                const disabledAttr = isTransient ? 'disabled' : '';

                const ownerGroup = document.getElementById('ownerGroupContainer').dataset.currentGroup || 'PD';

                tr.innerHTML = `
                    <td class="ps-4">
                        <div class="form-check">
                            <input class="form-check-input row-checkbox" type="checkbox" ${isEditMode || isTransient ? 'disabled' : ''}>
                        </div>
                    </td>
                    <td>
                        <div class="fw-bold">
                            ${agent.name}
                            ${serverTypeBadge}
                        </div>
                    </td>
                    <td><span class="badge rounded-pill text-bg-secondary bg-opacity-75">${ownerGroup}</span></td>
                    <td>${agent.ip || '192.168.0.1'}</td>
                    <td><span class="badge ${badgeClass}">${agent.status}</span></td>
                    <td>${lastUpdate}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-info me-1" title="Console View" onclick="event.stopPropagation(); window.location.href='agent-details.html?id=${agent.id}&name=${agent.name}&ip=${agent.ip || ''}&serverType=${agent.serverType || ''}&from=group'" ${disabledAttr}>
                            <i class="bi bi-terminal"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary btn-edit-agent me-1" title="Edit Agent" onclick="event.stopPropagation(); window.location.href='agent-form.html?id=${agent.id}&from=group&serverType=${agent.serverType || ''}'" ${disabledAttr}>
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-remove-agent" title="Remove from Group" onclick="event.stopPropagation(); removeAgent(this)" ${disabledAttr}>
                            <i class="bi bi-dash-lg"></i>
                        </button>
                    </td>
                `;

                // Add Click Event for Selection (Only in View Mode)
                tr.addEventListener('click', function (e) {
                    if (isEditMode) return; // Disable row click selection in Edit Mode
                    // Prevent selection for transient statuses
                    if (agent.status === 'STARTING' || agent.status === 'STOPPING') return;

                    if (e.target.closest('button')) return;
                    const checkbox = this.querySelector('.row-checkbox');
                    if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
                    toggleSelection(this, checkbox.checked);
                });

                tableBody.appendChild(tr);
            });
        }

        selectAllCheckbox.addEventListener('change', function () {
            if (isEditMode) {
                this.checked = false; // Prevent checking in edit mode
                return;
            }
            const isChecked = this.checked;
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const cb = row.querySelector('.row-checkbox');
                // Skip if disabled (transient status or edit mode)
                if (cb.disabled) return;

                cb.checked = isChecked;
                toggleSelection(row, isChecked);
            });
        });

        function toggleSelection(row, isSelected) {
            const checkbox = row.querySelector('.row-checkbox');
            checkbox.checked = isSelected;

            if (isSelected) {
                row.classList.add('selected');
                selectedRows.add(row);
            } else {
                row.classList.remove('selected');
                selectedRows.delete(row);
            }
            updateToolbar();
        }

        function updateToolbar() {
            countBadge.textContent = selectedRows.size;
            if (selectedRows.size > 0 && !isEditMode) {
                toolbar.classList.add('show');
            } else {
                toolbar.classList.remove('show');
            }

            // Update Select All Checkbox state
            const totalRows = tableBody.querySelectorAll('tr').length;
            selectAllCheckbox.checked = (totalRows > 0 && selectedRows.size === totalRows);
            selectAllCheckbox.indeterminate = (selectedRows.size > 0 && selectedRows.size < totalRows);
        }

        function clearSelection() {
            selectedRows.forEach(row => {
                row.classList.remove('selected');
                row.querySelector('.row-checkbox').checked = false;
            });
            selectedRows.clear();
            updateToolbar();
        }

        // --- Add/Remove Logic ---
        function openAddAgentModal() {
            const modal = new bootstrap.Modal(document.getElementById('addAgentModal'));
            modal.show();
        }

        function addSelectedAgents() {
            const checkboxes = document.querySelectorAll('#availableAgentList input:checked');
            if (checkboxes.length === 0) return;

            const ownerGroup = document.getElementById('ownerGroupContainer').dataset.currentGroup || 'PD';
            const now = new Date().toISOString().slice(0, 16).replace('T', ' ');

            checkboxes.forEach(cb => {
                const name = cb.nextElementSibling.querySelector('strong').innerText;
                const id = cb.value;

                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.dataset.status = 'STOPPED';
                tr.innerHTML = `
                    <td class="ps-4">
                        <div class="form-check">
                            <input class="form-check-input row-checkbox" type="checkbox" disabled>
                        </div>
                    </td>
                    <td>
                        <div class="fw-bold">
                            ${name}
                            <span class="badge bg-light text-secondary border ms-1">DEV</span>
                        </div>
                    </td>
                    <td><span class="badge rounded-pill text-bg-secondary bg-opacity-75">${ownerGroup}</span></td>
                    <td>192.168.0.100</td>
                    <td><span class="badge bg-danger bg-opacity-10 text-danger border border-danger">STOPPED</span></td>
                    <td>${now}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-info me-1" title="Console View" onclick="event.stopPropagation(); window.location.href='agent-details.html?id=${id}&from=group'">
                            <i class="bi bi-terminal"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary btn-edit-agent me-1" title="Edit Agent" onclick="event.stopPropagation(); window.location.href='agent-form.html?id=${id}&from=group'">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-remove-agent" title="Remove from Group" onclick="event.stopPropagation(); removeAgent(this)">
                            <i class="bi bi-dash-lg"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            document.getElementById('emptyState').classList.add('d-none');
            const modalEl = document.getElementById('addAgentModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            showToast('Agent가 그룹에 추가되었습니다.');
        }

        function removeAgent(btn) {
            showConfirm('이 그룹에서 해당 Agent를 제외하시겠습니까?', () => {
                const row = btn.closest('tr');
                if (selectedRows.has(row)) {
                    toggleSelection(row, false);
                }
                row.remove();
                if (tableBody.querySelectorAll('tr').length === 0) {
                    document.getElementById('emptyState').classList.remove('d-none');
                }
                showGlobalToast('Agent가 그룹에서 제외되었습니다.', 'warning');
            });
        }

        // --- Group Bulk Action ---
        function runGroupBulkAction(action) {
            const mode = document.querySelector('input[name="execMode"]:checked').value;

            const selectedAgents = Array.from(selectedRows).map(row => {
                return {
                    name: row.querySelector('td:nth-child(2) .fw-bold').childNodes[0].textContent.trim(),
                    serverType: row.dataset.serverType || (row.querySelector('.badge.bg-primary') ? 'PROD' : 'DEV')
                };
            });

            if (selectedAgents.length === 0) return;

            const agentNames = selectedAgents.map(a => a.name);
            const prodAgents = selectedAgents.filter(a => a.serverType === 'PROD').map(a => a.name);

            const executeAction = () => {
                showGlobalToast(`${action} command initiated in ${mode} mode...`);
                setProcessingState(true); // Disable Edit Button

                let completedCount = 0;
                const total = agentNames.length;
                const checkCompletion = () => {
                    completedCount++;
                    if (completedCount === total) {
                        setTimeout(() => {
                            showGlobalToast('All commands completed.');
                            setProcessingState(false); // Re-enable Edit Button
                        }, 500);
                    }
                };

                if (mode === 'PARALLEL') {
                    // Parallel Simulation
                    agentNames.forEach(name => {
                        console.log(`[PARALLEL] Sending ${action} to ${name}`);
                        setTimeout(() => {
                            showGlobalToast(`[${name}]${action} Completed!`);
                            checkCompletion();
                        }, Math.random() * 2000 + 500);
                    });
                } else {
                    // Sequential Simulation
                    let delay = 0;
                    agentNames.forEach((name, index) => {
                        setTimeout(() => {
                            console.log(`[SEQUENTIAL] Sending ${action} to ${name}`);
                            showGlobalToast(`[${name}]${action} Completed!(${index + 1}/${agentNames.length})`);
                            checkCompletion();
                        }, delay);
                        delay += 1500;
                    });
                }
            };

            if (prodAgents.length > 0) {
                showProdSafetyConfirm(action, prodAgents, executeAction);
            } else {
                const confirmMsg = `[${mode}] 모드로 ${agentNames.length}개의 에이전트에[${action}] 명령을 수행하시겠습니까 ?\n\n대상: ${agentNames.join(', ')} `;
                showConfirm(confirmMsg, executeAction);
            }
        }

        function setProcessingState(isProcessing) {
            const btnEdit = document.getElementById('btnEdit');

            // Toggle Group Edit Button
            if (isProcessing) {
                btnEdit.disabled = true;
                btnEdit.classList.add('disabled');
                btnEdit.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            } else {
                btnEdit.disabled = false;
                btnEdit.classList.remove('disabled');
                btnEdit.innerText = 'Edit';
            }

            // Toggle Agent Row Edit Buttons
            const rowEditButtons = document.querySelectorAll('.btn-edit-agent');
            rowEditButtons.forEach(btn => {
                btn.disabled = isProcessing; // Native Disable
                if (isProcessing) {
                    btn.classList.add('disabled');
                    btn.style.pointerEvents = 'none'; // Extra safety
                    btn.style.opacity = '0.5';
                } else {
                    btn.classList.remove('disabled');
                    btn.style.pointerEvents = 'auto';
                    btn.style.opacity = '1';
                }
            });
        }

        function showGlobalToast(msg, type = 'success') {
            const container = document.querySelector('.toast-container');
            // If container doesn't exist, fallback or create it (though it should exist from HTML)
            if (!container) return;

            // Create new toast element
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center border-0 mb-2';
            toastEl.role = 'alert';
            toastEl.ariaLive = 'assertive';
            toastEl.ariaAtomic = 'true';

            // Set colors
            if (type === 'warning' || type === 'danger') {
                toastEl.classList.add('text-bg-danger');
            } else {
                toastEl.classList.add('text-bg-dark');
            }

            toastEl.innerHTML = `
            < div class="d-flex" >
                    <div class="toast-body">
                        ${msg}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div >
            `;

            container.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 }); // Auto hide after 3s
            toast.show();

            // Remove from DOM after hidden
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }

        // Initial setup for View Mode
        toggleEditMode(false);
    </script>
</body>

</html>