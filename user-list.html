<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Deploy System Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/layout.css" rel="stylesheet">
</head>

<body>

    <div id="header-container"></div>
    <script src="js/header.js"></script>

    <div class="d-flex">
        <!-- Sidebar -->
        <!-- Sidebar -->
        <div id="sidebar-container"></div>
        <script src="js/sidebar.js"></script>

        <!-- Content Area -->
        <div class="content-area">
            <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
                <h4><i class="bi bi-people-fill me-2"></i>Members</h4>

                <!-- Permission Simulation Control -->
                <!-- Global Simulator used in Header -->
            </div>

            <!-- Filter Card -->
            <div class="card shadow-sm border-0 mb-4" id="filterCard" style="display: none;">
                <div class="card-body bg-light">
                    <form id="userFilterForm" onsubmit="event.preventDefault(); renderTable();">
                        <div class="row mb-2">
                            <div class="col-12">
                                <label class="col-form-label fw-bold small text-uppercase text-secondary">Filter
                                    by</label>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="searchName" class="form-label small fw-bold">Name</label>
                                <input type="text" class="form-control form-control-sm" id="searchName"
                                    placeholder="ex) 홍길동">
                            </div>
                            <div class="col-md-4">
                                <label for="searchStatus" class="form-label small fw-bold">Status</label>
                                <select class="form-select form-select-sm" id="searchStatus">
                                    <option value="">ALL</option>
                                    <option value="NORMAL">NORMAL</option>
                                    <option value="PENDING_SIGNUP">PENDING_SIGNUP</option>
                                    <option value="PENDING_DELETE">PENDING_DELETE</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="filterLevelContainer" style="display: none;">
                                <label for="searchLevel" class="form-label small fw-bold">Level (Admin Only)</label>
                                <select class="form-select form-select-sm" id="searchLevel">
                                    <option value="">ALL</option>
                                    <option value="Admin">Admin</option>
                                    <option value="Master">Master</option>
                                    <option value="Content">Content</option>
                                    <option value="Report">Report</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="filterGroupContainer" style="display: none;">
                                <label for="searchGroup" class="form-label small fw-bold">Group (Admin Only)</label>
                                <select class="form-select form-select-sm" id="searchGroup">
                                    <option value="">ALL</option>
                                    <option value="PD">PD</option>
                                    <option value="SO">SO</option>
                                    <option value="OP">OP</option>
                                    <option value="QA">QA</option>
                                    <option value="Common">Common</option>
                                </select>
                            </div>

                            <div class="col-md-4 d-flex align-items-end justify-content-end ms-auto">
                                <button type="button" class="btn btn-sm btn-secondary me-2" onclick="resetFilter()"><i
                                        class="bi bi-arrow-counterclockwise me-1"></i>Reset</button>
                                <button type="submit" class="btn btn-sm btn-primary px-4"><i
                                        class="bi bi-search me-1"></i>Search</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0" id="userTable">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="ps-4">이름 (Name)</th>
                                <th scope="col">소속 / 팀</th>
                                <th scope="col">직급</th>
                                <th scope="col">상태 (Status)</th>
                                <th scope="col">계정 등급 (Level)</th>
                                <th scope="col">계정 그룹 (Group)</th>
                                <th scope="col">사용 만료일</th>
                                <th scope="col" class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination (Static for now) -->
                <div class="card-footer bg-white d-flex justify-content-end py-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">Next</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        // Mock Data
        const users = [
            {
                id: 'hong.kd', name: '홍길동', dept: 'Tech1실', team: '플랫폼개발팀', rank: '팀장',
                status: 'NORMAL', level: 'Master', group: 'PD', expireDate: '2024-12-31'
            },
            {
                id: 'kim.cs', name: '김철수', dept: 'Tech2실', team: '서비스운영팀', rank: '매니저',
                status: 'PENDING_SIGNUP', level: 'Content', group: 'SO', expireDate: '2024-06-30'
            },
            {
                id: 'lee.yh', name: '이영희', dept: 'Tech1실', team: '데이터분석팀', rank: '매니저',
                status: 'PENDING_DELETE', level: 'Report', group: 'PD', expireDate: '2024-12-31'
            }
        ];

        // Current User Logic (Handled by Global Header Simulator)
        // Listen for context change
        document.addEventListener('userContextChanged', (e) => {
            // currentUser is already updated in window object by header.js
            // But we can also use e.detail if needed
            renderTable();
            updateAdminMenuVisibility(currentUser.level); // Update Menu
            showToast(`[Page] View updated for: ${currentUser.level}`);
        });

        // Permission Check Function
        function canEditOrDelete(targetUser) {
            // 1. Admin: All allowed
            if (currentUser.level === 'Admin') return true;

            // 2. Self: Always allowed
            if (currentUser.id === targetUser.id) return true;

            // 3. Master: Self + Same Group
            if (currentUser.level === 'Master') {
                return currentUser.group === targetUser.group;
            }

            // 4. Content/Report: Self Only (Already covered by check #2)
            return false;
        }

        // Self Status Action Handler (Cancel Delete)
        function handleSelfStatusAction(userId, actionType) {
            if (userId !== currentUser.id) return;

            if (actionType === 'CANCEL_DELETE') {
                showConfirm('삭제 요청을 취소하시겠습니까?<br><span class="text-success small">(상태가 [정상]으로 변경됩니다)</span>', function () {
                    const user = users.find(u => u.id === userId);
                    if (user) {
                        user.status = 'NORMAL';
                        renderTable();
                        showToast('삭제 요청이 취소되었습니다.', 'success');
                    }
                });
            }
        }

        // Admin Status Action Handler
        function handleStatusAction(userId, currentStatus) {
            if (currentUser.level !== 'Admin') return;

            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) return;

            if (currentStatus === 'PENDING_SIGNUP') {
                showConfirm('가입완료 상태로 변경 할까요?', function () {
                    users[userIndex].status = 'NORMAL';
                    renderTable();
                    showToast(`${userId} 계정이 정상 상태로 변경되었습니다.`, 'success');
                });
            } else if (currentStatus === 'PENDING_DELETE') {
                showConfirm('계정을 삭제 할까요?', function () {
                    users.splice(userIndex, 1);
                    renderTable();
                    showToast(`${userId} 계정이 삭제되었습니다.`, 'success');
                });
            }
        }

        // Delete Button Handler
        function handleDeleteClick(userId) {
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) return;
            const user = users[userIndex];

            // 1. PENDING_SIGNUP: Immediate Cancel/Delete (Regardless of role, if button is clickable)
            if (user.status === 'PENDING_SIGNUP') {
                showConfirm('가입 요청을 취소하시겠습니까?<br><span class="text-danger small">(정보가 영구 삭제됩니다)</span>', function () {
                    users.splice(userIndex, 1);
                    renderTable();
                    showToast('가입 요청이 취소되었습니다.', 'success');
                });
                return;
            }

            // 2. Admin: Immediate Delete
            if (currentUser.level === 'Admin') {
                showConfirm(`[관리자] '${user.name}' 계정을 영구히 삭제하시겠습니까?`, function () {
                    users.splice(userIndex, 1);
                    renderTable();
                    showToast('계정이 삭제되었습니다.', 'success');
                });
            } else {
                // 3. Non-Admin: Request Delete
                showConfirm('계정 삭제를 관리자에게 요청하시겠습니까?<br><span class="text-danger small">(상태가 [삭제대기]로 변경됩니다)</span>', function () {
                    user.status = 'PENDING_DELETE';
                    renderTable();
                    showToast('계정 삭제 요청이 접수되었습니다.', 'success');
                });
            }
        }

        // Initialize Filter Visibility based on Permissions
        function applyFilterVisibility() {
            const filterCard = document.getElementById('filterCard');
            const filterLevelContainer = document.getElementById('filterLevelContainer');
            const filterGroupContainer = document.getElementById('filterGroupContainer');

            if (!filterCard || !filterLevelContainer || !filterGroupContainer) return;

            // Default: Hide all
            filterCard.style.display = 'none';
            filterLevelContainer.style.display = 'none';
            filterGroupContainer.style.display = 'none';

            if (currentUser.level === 'Admin') {
                // Admin: Show All
                filterCard.style.display = 'block';
                filterLevelContainer.style.display = 'block';
                filterGroupContainer.style.display = 'block';
            } else if (currentUser.level === 'Master') {
                // Master: Show Name/Status only (Hide Level/Group)
                filterCard.style.display = 'block';
                filterLevelContainer.style.display = 'none';
                filterGroupContainer.style.display = 'none';
            } else {
                // Content/Report: Hide Filter Card
                filterCard.style.display = 'none';
            }
        }

        function resetFilter() {
            const inputs = ['searchName', 'searchStatus', 'searchLevel', 'searchGroup'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            renderTable();
        }

        function renderTable() {
            // Apply UI Visibility Logic
            applyFilterVisibility();

            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '';

            // 1. Permission Logic (Data Scope)
            let displayUsers = users;
            if (currentUser.level === 'Content' || currentUser.level === 'Report') {
                // Content/Report: Show ONLY Self
                displayUsers = users.filter(u => u.id === currentUser.id);
            } else if (currentUser.level === 'Master') {
                // Master: Show Self + Same Group
                displayUsers = users.filter(u => u.group === currentUser.group);
            }

            // 2. Filter Logic (Search Inputs)
            const searchName = document.getElementById('searchName')?.value.trim().toLowerCase() || '';
            const searchStatus = document.getElementById('searchStatus')?.value || '';
            const searchLevel = document.getElementById('searchLevel')?.value || '';
            const searchGroup = document.getElementById('searchGroup')?.value || '';

            // Only apply filters if the user has permission to see the filter UI
            // (or implicitly if values are set)
            displayUsers = displayUsers.filter(user => {
                const matchName = user.name.toLowerCase().includes(searchName) || user.id.toLowerCase().includes(searchName);
                const matchStatus = searchStatus === '' || user.status === searchStatus;

                // Level/Group filter only applies if visible (Admin)
                // However, if the element is hidden, its value is '', so it works automatically as 'ALL'
                const matchLevel = searchLevel === '' || user.level === searchLevel;
                const matchGroup = searchGroup === '' || user.group === searchGroup;

                return matchName && matchStatus && matchLevel && matchGroup;
            });

            displayUsers.forEach(user => {
                const tr = document.createElement('tr');

                // Status Badge Logic
                let statusBadge = '';
                let statusAction = '';
                let cursorStyle = '';
                let title = '';

                // 1. Self Action (Cancel Delete Request) - Priority
                if (currentUser.id === user.id && user.status === 'PENDING_DELETE') {
                    statusAction = `onclick="handleSelfStatusAction('${user.id}', 'CANCEL_DELETE')"`;
                    cursorStyle = 'cursor: pointer;';
                    title = '클릭하여 삭제 요청 취소';
                }
                // 2. Admin Action (Approve Signup / Confirm Delete)
                else if (currentUser.level === 'Admin') {
                    if (user.status === 'PENDING_SIGNUP') {
                        statusAction = `onclick="handleStatusAction('${user.id}', 'PENDING_SIGNUP')"`;
                        cursorStyle = 'cursor: pointer;';
                        title = '클릭하여 가입 승인';
                    } else if (user.status === 'PENDING_DELETE') {
                        statusAction = `onclick="handleStatusAction('${user.id}', 'PENDING_DELETE')"`;
                        cursorStyle = 'cursor: pointer;';
                        title = '클릭하여 계정 삭제';
                    }
                }

                if (user.status === 'NORMAL') {
                    statusBadge = '<span class="badge bg-success">정상</span>';
                } else if (user.status === 'PENDING_SIGNUP') {
                    statusBadge = `<span class="badge bg-warning text-dark shadow-sm" style="${cursorStyle}" ${statusAction} title="${title}">가입대기</span>`;
                } else if (user.status === 'PENDING_DELETE') {
                    statusBadge = `<span class="badge bg-danger shadow-sm" style="${cursorStyle}" ${statusAction} title="${title}">삭제대기</span>`;
                }

                // Level Badge Logic
                let levelClass = 'bg-secondary';
                if (user.level === 'Master') levelClass = 'bg-danger';
                else if (user.level === 'Content') levelClass = 'bg-primary';

                // Group Badge Logic
                let groupClass = 'bg-dark';
                if (user.group === 'SO') groupClass = 'bg-info text-dark';

                // Permission Check
                const isActionAllowed = canEditOrDelete(user);
                const btnState = isActionAllowed ? '' : 'disabled style="opacity: 0.3; cursor: not-allowed;"';

                // Edit Button Visibility (Hide for PENDING_SIGNUP)
                let editButtonHtml = `
                        <button class="btn btn-sm btn-outline-secondary me-1" ${btnState} onclick="location.href='./user-form.html?id=${user.id}'">
                            <i class="bi bi-pencil"></i>
                        </button>`;

                if (user.status === 'PENDING_SIGNUP' && currentUser.level !== 'Admin') {
                    editButtonHtml = '';
                }

                tr.innerHTML = `
                    <td class="ps-4">
                        <div class="fw-bold">${user.name}</div>
                        <small class="text-muted">${user.id}</small>
                    </td>
                    <td>
                        <div>${user.dept}</div>
                        <small class="text-muted">${user.team}</small>
                    </td>
                    <td>${user.rank}</td>
                    <td>${statusBadge}</td>
                    <td><span class="badge ${levelClass}">${user.level}</span></td>
                    <td><span class="badge ${groupClass}">${user.group}</span></td>
                    <td>${user.expireDate}</td>
                    <td class="text-end pe-4">
                        ${editButtonHtml}
                        <button class="btn btn-sm btn-outline-danger" ${btnState} onclick="handleDeleteClick('${user.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Initial Render
        renderTable();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
</body>

</html>